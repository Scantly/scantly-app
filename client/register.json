{"files":[{"id":"652ba3c9-b102-4061-a106-9fa769b7cd07","name":"Server","type":"server_js","source":"function doGet(e) {\n  return handleResponse(e);\n}\n\nfunction doPost(e) {\n  return handleResponse(e);\n}\n\nfunction handleResponse(e) {\n  \n  // -- Get Parameters from Query String -- //\n  var _user \u003d e.parameter ? e.parameter.u : null,\n      _user_key \u003d e.parameter ? e.parameter.u_k : null,\n      _location \u003d e.parameter ? e.parameter.l : null,\n      _location_key \u003d e.parameter ? e.parameter.l_k : null,\n      _callback \u003d e.parameter ? e.parameter.callback : null;\n      \n  // -- Base64 Decode as required -- //\n  if (_user) _user \u003d Utilities.newBlob(Utilities.base64Decode(_user)).getDataAsString();\n  if (_location) _location \u003d Utilities.newBlob(Utilities.base64Decode(_location)).getDataAsString();\n  \n  // -- Log Action -- //\n  var _result \u003d log(_user, _user_key, _location, _location_key);\n  \n  // -- Return to JSONP callback function, if required -- //\n  if (_callback) return ContentService\n      .createTextOutput(_callback + \"(\" + JSON.stringify(_result) + \")\")   \n      .setMimeType(ContentService.MimeType.JAVASCRIPT); \n\n}"},{"id":"fb034fdd-794c-4b1d-bbb1-cbfa6e3b43b8","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"Europe/London\",\n  \"dependencies\": {\n    \"libraries\": [{\n      \"userSymbol\": \"JSRSASIGN\",\n      \"libraryId\": \"1Q69EWHz30dKAVH2aTFL3Yj4oD-2QRvrOwSDs2xUf0NFCvZxSavurfrR-\",\n      \"version\": \"3\"\n    }]\n  },\n  \"webapp\": {\n    \"access\": \"ANYONE_ANONYMOUS\",\n    \"executeAs\": \"USER_DEPLOYING\"\n  },\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\"\n}"},{"id":"09eff850-18fe-4d1b-a460-351367f99a88","name":"API","type":"server_js","source":"function parse(value, key, public_key) {\n\n  if (value \u0026\u0026 key) {\n  \n    var _verified \u003d _verify(value, key, public_key);\n    \n    if (_verified \u003d\u003d\u003d true) {\n    \n      var _parsed \u003d /^(.+)\\s+\u003c\u003d\\s+(\\d{4}-\\d{2}-\\d{2}$)/gi.exec(value);\n      \n      if (_parsed \u0026\u0026 _parsed.length \u003d\u003d\u003d 3) {\n      \n        var _until \u003d _parsed[2], \n            _return \u003d {\n              raw : value,\n              value : _parsed[1],\n              verified : _verified\n            };\n        \n        if (new Date().toISOString().split(\"T\")[0] \u003c\u003d _until) {\n          \n          _return.valid \u003d true;\n          \n        } else {\n          \n          _return.valid \u003d false;\n          _return.text \u003d Utilities.formatString(\"%s [EXPIRED]\", _return.value);\n            \n        }\n        \n        return _return;\n        \n      } else {\n      \n        return _verified;\n      \n      }\n      \n    } else {\n    \n      return _verified;\n      \n    }\n  \n  }\n  \n}\n\nfunction log(user, user_key, location, location_key) {\n\n  var _user \u003d parse(user, user_key),\n      _location \u003d parse(location, location_key),\n      _presence \u003d null,\n      _verified \u003d false;\n      \n  if (_user \u003d\u003d\u003d true || (_user \u0026\u0026 _user.verified \u003d\u003d\u003d true)) {\n  \n    var _value \u003d _user.value || user,\n        _cache \u003d CacheService.getScriptCache(),\n        _current \u003d _cache.get(_value) ? false : true;\n    \n    _current ? _cache.put(_value, \"1\", 48 * 60 * 60) : _cache.remove(_value); // 48hr Cache Time\n    _presence \u003d _current;\n    \n    SpreadsheetApp.getActiveSpreadsheet().getSheetByName(\"LOG\").appendRow([new Date(),\n      _location ? _location \u003d\u003d\u003d true ? location : _location.verified \u003d\u003d\u003d true ? _location.valid \u003d\u003d\u003d true ? _location.value : _location.text : \"\" : \"\",\n      _presence \u003d\u003d\u003d true ? \"SIGN-IN\" : _presence \u003d\u003d\u003d false ? \"SIGN-OUT\" : \"SCAN\",\n      _user \u003d\u003d\u003d true ? user : _user.valid \u003d\u003d\u003d true ? _user.value : _user.text]);\n    \n    _verified \u003d true;\n    \n  }\n  \n  return {result : _verified, valid: _user \u003d\u003d\u003d true || (_user \u0026\u0026 _user.valid \u003d\u003d\u003d true), presence: _presence};\n  \n}"},{"id":"4ab9ec3f-ff65-462b-ba51-c917a7a5af7e","name":"Crypto","type":"server_js","source":"var PUBLIC_KEY \u003d \"{{{KEY}}}\";\n\nvar navigator \u003d {}, window \u003d {};\n\nfunction _verify(value, signature, public_key) {\n  var sig_Verify \u003d new JSRSASIGN.KJUR.crypto.Signature({\"alg\": \"SHA256withRSA\"});\n  sig_Verify.init(public_key || PUBLIC_KEY);\n  sig_Verify.updateString(value);\n  return sig_Verify.verify(signature);\n}"},{"id":"f319afb5-ce04-462a-9e04-21d37ac8542e","name":"Entry","type":"server_js","source":"function onInstall(e) {\n  onOpen();\n}\n\nfunction onOpen() {\n  var ui \u003d SpreadsheetApp.getUi();\n  ui.createMenu(\"Tasks\")\n      .addItem(\"Authorise\", \"authoriseServer\")\n      .addToUi();\n};\n\nfunction authoriseServer() {\n  ScriptApp.getOAuthToken();\n}"},{"id":"5349a331-1463-4811-bab8-dd32c327ba33","name":"Versions","type":"server_js","source":"// -- All String Keys have to be quoted for JSON Parsing -- //\nvar VERSIONS \u003d [{\n  \"v1_0_0\" : {\n    \"version\": \"1.0.0\",\n    \"description\": \"New Release Version\"\n  }\n}];"}]}